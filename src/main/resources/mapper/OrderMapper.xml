<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.carsale.mapper.OrderMapper">

    <resultMap id="BaseResultMap" type="com.carsale.pojo.Order">
            <id property="id" column="id" jdbcType="INTEGER"/>
            <result property="productid" column="productId" jdbcType="INTEGER"/>
            <result property="userid" column="userId" jdbcType="INTEGER"/>
            <result property="warehouseid" column="warehouseId" jdbcType="INTEGER"/>
            <result property="createtime" column="createtime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,productId,userId,
        warehouseId,createtime
    </sql>

    <insert id="insertOrder" parameterType="com.carsale.pojo.Order" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `order` (productId, userId, warehouseId)
        VALUES (#{TableOrder.productid}, #{TableOrder.userid}, #{TableOrder.warehouseid});
    </insert>

    <update id="updateOrderById" parameterType="com.carsale.pojo.Order">
        UPDATE `order`
        SET productId = ${TableOrder.productid},
            userId = ${TableOrder.userid},
            warehouseId = ${TableOrder.warehouseid}
        WHERE id = ${TableOrder.id}
    </update>


    <delete id="deleteOrderByProductId">
        delete
        from `order`
        where `order`.productId = #{productId}

    </delete>

    <delete id="deleteOrderByWarehouseId">
        delete
        from `order`
        where `order`.warehouseId = #{warehouseId}
    </delete>

    <delete id="deleteOrderById">
        delete
        from `order`
        where `order`.id = #{id}
    </delete>

    <!-- 获取订单总数 -->
    <select id="selectOrderCount" resultType="java.lang.Long">
        SELECT COUNT(*) FROM `order`;
    </select>

    <!-- 分页查询订单列表 -->
    <select id="selectOrderPage" resultMap="BaseResultMap">
        SELECT * FROM `order`
                          LIMIT #{page}, #{pageSize};
    </select>

    <select id="selectOrderById" resultType="com.carsale.pojo.Order">
        select *
        from `order`
        where `order`.id = #{orderId}
    </select>

    <select id="selectIncome" resultType="java.lang.Double">
        SELECT ROUND(SUM(price),2)
        from `order` LEFT JOIN product
                               ON `order`.productId = product.id
    </select>

    <select id="sales" resultType="java.lang.Integer">
        SELECT COUNT(price)
        from `order` LEFT JOIN product
                               ON `order`.productId = product.id
    </select>

    <select id="warehouses" resultType="java.lang.Integer">
        SELECT count(*)
        FROM warehouse
    </select>

    <select id="users" resultType="java.lang.Integer">
        SELECT count(*)
        FROM user
    </select>

    <select id="selectTopUserId" resultType="java.lang.Integer">
        SELECT
            u.id
        FROM
            `order` o
                JOIN
            user u ON o.userId = u.id
                JOIN
            product p ON o.productId = p.id
        WHERE
            YEAR(o.createtime) >= YEAR(CURDATE()) - 4
        GROUP BY
            u.id
        ORDER BY
            ROUND(SUM(p.price),2) DESC
            LIMIT
            7;
    </select>
    <select id="selectTopUserName" resultType="java.lang.String">
        SELECT
            u.username
        FROM
            `order` o
                JOIN
            user u ON o.userId = u.id
                JOIN
            product p ON o.productId = p.id
        WHERE
            YEAR(o.createtime) >= YEAR(CURDATE()) - 4
        GROUP BY
            u.username
        ORDER BY
            ROUND(SUM(p.price),2) DESC
            LIMIT
            7;
    </select>

    <select id="selectSalesByYearAndUserId" resultType="java.lang.Double">
        SELECT ROUND(SUM(p.price),2) AS sales
        FROM `order` o
                 JOIN product p ON o.productId = p.id
        WHERE YEAR(o.createTime) = #{year} AND o.userId = #{id}

    </select>

    <select id="selectTopCarId" resultType="java.lang.Integer">
        SELECT
            p.id
        FROM
            `order` o
                JOIN
            product p ON o.productId = p.id
        WHERE
            YEAR(o.createtime) >= YEAR(CURDATE()) - 4
        GROUP BY
            p.id
        ORDER BY
            ROUND(SUM(p.price),2) DESC
            LIMIT
            7;
    </select>

    <select id="selectTopCarName" resultType="java.lang.String">
        SELECT
            p.`name`,p.id
        FROM
            `order` o
                JOIN
            product p ON o.productId = p.id
        WHERE
            YEAR(o.createtime) >= YEAR(CURDATE()) - 4
        GROUP BY
            p.id
        ORDER BY
            ROUND(SUM(p.price),2) DESC
            LIMIT
            7;
    </select>

    <select id="selectSalesByYearAndCarId" resultType="java.lang.Integer">
        SELECT COUNT(*) AS sales
        FROM `order` o
                 JOIN product p ON o.productId = p.id
        WHERE YEAR(o.createTime) = #{year} AND o.productId = #{id}
    </select>


</mapper>
